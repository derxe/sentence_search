<!doctype html>
<html lang="en">
<head>
    <title>Sentence Search - Report a problem</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.png">
</head>

<body>

<script>
    let userDetails = {};
  
    function getQueryParams(qs) {
        qs = qs.split('+').join(' ');

        var params = {},
            tokens,
            re = /[?&]?([^=]+)=([^&]*)/g;

        while (tokens = re.exec(qs)) {
            params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);
        }

        return params;
    }
    
    function gatherUserDetails() {
      $.getJSON('https://ipapi.co/json/', function(data) {
        userDetails["ip"] = data;
      });
      
      // collect some data from navigator object
      userDetails.navigator = {};
      let properties = ["appCodeName", "appName", "appVersion", 
        "language", "langauges", "platform", "product", "productSub", 
        "userAgent", "vendor"];
      let i;
      for(i=0; i<properties.length; i++){
          userDetails.navigator[properties[i]] = navigator[properties[i]];
      }
      
      userDetails.screen = screen;
      userDetails.screen["docW"] = document.width;
      userDetails.screen["docH"] = document.height;
      userDetails.screen["inw"] = innerWidth;
      userDetails.screen["inH"] = innerHeight;
    }

    $(document).ready(() => {
        gatherUserDetails();
      
        let params = getQueryParams(document.location.search);
        let rawJson = decodeURIComponent(params.sen);
        let reportedSentence = JSON.parse(rawJson);

        $("#jap").html(reportedSentence.sentence);
        $("#eng").html(reportedSentence.eng);
        $("#audio").attr("href", reportedSentence.audio);
        handleAudio(); // plays audio when play button is clicked

        $("#submit-report").click(() => {
            let reportMessage = $("#report-message").val();

            let report = {
                "date": new Date() + "",
                "message": reportMessage,
                "sentence": reportedSentence,
                "user_details": userDetails
            }

            $("#submit-report").attr("disabled", "disabled");
            $("#submit-report").html("Sending ...");
            $("#lovely-message").hide();
            $("#error-message").hide();

            console.log("Posting report:", report);
            return;
            $.ajax({
                type: "POST",
                url: "https://receptomanijalogi.firebaseio.com/report.json",
                data: JSON.stringify(report),
                success: function () {
                    console.log("Report successfully sendededed!")

                    $("#submit-report").html("Report Sent");
                    $("#after-report-message").show();
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.error("Error sending a report", ajaxOptions, thrownError);
                    $("#submit-report").attr("disabled", false);
                    $("#submit-report").html("Try again?");

                    $("#error-message").html("There was an error sending the report: " + thrownError);
                    $("#error-message").show();
                },
                dataType: "json",
                contentType: "application/json"
            });
        });
    });


</script>
<div class="container">
    <div class="row">
        <div class="col-lg-6">
            <h4 class="mt-3">Report a problem</h4>
            <p>Please describe what is wrong with the sentence: </p>
            Japanese: <span id="jap"></span> <a id="audio" class="audioButton audioIdle"
                                                onclick="return false"></a>
            <br>
            English: <span id="eng"></span>
            <br>
            <br>
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        <textarea class="form-control textarea" rows="3" id="report-message"
                                  placeholder="Describe what is wrong with the sentence"></textarea>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <button id="submit-report" class="btn main-btn pull-right">Send report</button>
                </div>
            </div>
            <br>
            <div id="error-message" class="alert alert-danger" style="display:none"></div>
            <div id="after-report-message" style="display:none">
                <div class="alert alert-success">
                    Thank you so much for submitting your report. <br>
                    Your contribution is much appreciated <3
                </div>
            </div>
            You can find all the reports including yours here
            <a id="submit-report" class="btn btn-outline-secondary btn-sm" href="/reports_list.html">View
                reports</a>
        </div>
    </div>

</div>

<!-- preload images -->
<div style="display:none;">
    <img src="img/audio_loading.svg"/>
    <img src="img/audio_idle.svg"/>
    <img src="img/audio_error.svg"/>
    <img src="img/audio_playing.svg"/>
</div>

<script src="script/audio.js"></script>

</body>


</html>


